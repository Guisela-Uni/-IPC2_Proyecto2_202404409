<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invernadero</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='estilo.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/iconoInv.png') }}">
</head>
<body>
    <header class="header" id="inicio">
        <div class="contenedor head">
            <a id="Ayuda" class="presionar help" href="{{ url_for('ayuda') }}">Ayuda</a>
            <h1 class="titulo">Invernadero GuateRiegos 2.0</h1>
            <p class="copy">Sistema de optimización para riego y aplicación de fertilizante</p>
        </div>
    </header>

    <main>
        <section class="contenedor" id="items">
            <div class="right-panel">
                <form class="container" method="POST" action="/formulario" enctype="multipart/form-data">
                    <h2 class="subtitulo">Cargar Archivo .xml</h2>
                    <input id="fileXML" type="file" name="archivo" accept=".xml" required>
                    <button class="boton" type="submit">Procesar XML</button>
                </form>
            </div>
        </section>
        <br>

        {% if invernaderos %}
        <form method="POST" action="/procesar_seleccion">
            <input type="hidden" name="archivo_nombre" value="{{ uploaded_filename }}">

            <label for="invernadero">Invernadero:</label>
            <select name="invernadero" id="invernadero" required>
                {% for nombre in invernaderos %}
                    <option value="{{ nombre }}"
                        {% if seleccion_actual and seleccion_actual.invernadero == nombre %}selected{% endif %}>
                        {{ nombre }}
                    </option>
                {% endfor %}
            </select>

            <label for="riego">Plan de riego:</label>
            <select name="riego" id="riego" required>
                {% for p in planes %}
                    <option value="{{ p }}"
                        {% if seleccion_actual and seleccion_actual.riego == p %}selected{% endif %}>
                        {{ p }}
                    </option>
                {% endfor %}
            </select>

            <label for="fertilizante">¿Aplicar fertilizante?</label>
            <select name="fertilizante" id="fertilizante">
                <option value="Sí" {% if seleccion_actual and seleccion_actual.fertilizante == 'Sí' %}selected{% endif %}>Sí</option>
                <option value="No" {% if seleccion_actual and seleccion_actual.fertilizante == 'No' %}selected{% endif %}>No</option>
            </select>

            <label for="tiempo_dron">Tiempo para análisis de drones (segundos):</label>
            <input type="number" name="tiempo_dron" id="tiempo_dron" min="1" required
                    value="{{ seleccion_actual.tiempo_dron if seleccion_actual else '' }}">

            <button type="submit">Procesar selección</button>
        </form>
        {% endif %}

        <!-- 
        <form method="POST" action="/reportes">
            
            <button type="submit">Generar reportes</button>
        </form>

        
        <form method="POST" action="/descargar_grafico">
            
            <button type="submit">Descargar Gráfico de Estados</button>
        </form-->

        {% if tiempo_total %}
        <div id="tiempo">
            <h2>Tiempo óptimo de riego: {{ tiempo_total }} segundos</h2>
        </div>
        {% endif %}

        {% if tabla %}
        <div id="resultado">
            <h2>Consumo por dron</h2>
            {{ tabla|safe }}
        </div>

        <form method="POST" action="/generar_simulacion">
            <input type="hidden" name="archivo_nombre" value="{{ uploaded_filename }}">
            <input type="hidden" name="invernadero" value="{{ seleccion_actual.invernadero }}">
            <input type="hidden" name="riego" value="{{ seleccion_actual.riego }}">
            <input type="hidden" name="fertilizante" value="{{ seleccion_actual.fertilizante }}">
            <input type="hidden" name="tiempo_dron" value="{{ seleccion_actual.tiempo_dron }}">
            <button type="submit">Visualizar recorrido</button>
        </form>
        {% endif %}

        {% if uploaded_filename %}
        <form method="POST" action="/generar_reporte_html">
            <!-- Pasamos el archivo cargado al backend -->
            <input type="hidden" name="archivo_nombre" value="{{ uploaded_filename }}">
            <button type="submit" class="boton">Descargar reporte html</button>
        </form>
        {% endif %}


        {% if tabla_eventos %}
        <div id="recorrido">
            <h2>Simulación paso a paso</h2>
            <!--button type="submit">Descargar Gráfico de Estados</button-->
            {{ tabla_eventos|safe }}
            <!-- Formulario para descargar gráfico -->
            <br>
            <br>
            <form method="POST" action="/descargar_grafico" style="display:inline;">
                <input type="hidden" name="archivo_nombre" value="{{ uploaded_filename }}">
                <input type="hidden" name="invernadero" value="{{ seleccion_actual.invernadero }}">
                <input type="hidden" name="riego" value="{{ seleccion_actual.riego }}">
                <input type="hidden" name="fertilizante" value="{{ seleccion_actual.fertilizante }}">
                <input type="hidden" name="tiempo_dron" value="{{ seleccion_actual.tiempo_dron }}">
                <button type="submit">Descargar Gráfico de Estados</button>
            </form>
        </div>
        {% endif %}
    </main>

    {% if imagen_estado %}
    <h2>Estados de Drones</h2>
    <img src="{{ url_for('static', filename='uploads/' + imagen_estado) }}" alt="Estados de Drones">
    {% endif %}

    {% if uploaded_filename %}
    <script>
        window.uploadedFilename = "{{ uploaded_filename }}";
    </script>
    {% endif %}
    <script src="{{ url_for('static', filename='js/funciones.js') }}"></script>
</body>
</html>